# Solidus Viabill

[![CircleCI](https://circleci.com/gh/solidusio-contrib/solidus_viabill.svg?style=shield)](https://circleci.com/gh/solidusio-contrib/solidus_viabill)
[![codecov](https://codecov.io/gh/solidusio-contrib/solidus_viabill/branch/master/graph/badge.svg)](https://codecov.io/gh/solidusio-contrib/solidus_viabill)

<!-- Explain what your extension does. -->

## Installation

Add solidus_viabill to your Gemfile:

```ruby
gem 'solidus_viabill'
```

Bundle your dependencies and run the installation generator:

```shell
bin/rails generate solidus_viabill:install
```

## Usage

Go to admin/payment_methods and click on `New Payment Method` Button

Select `Viabill Payment Method` in the type field and give your payment method a `name` and `description`.

Click on the `Create` to create your new payment method.

Now there are 2 ways to implement credentials for the extension

### 1. Custom Credentials Method

After the payment method is successfully created, you will get the following options.

- Server
- Test Mode
- Viabill api key
- Viabill secret key
- Viabill success url
- Viabill cancel url
- Viabill checkout url

The following values are recommended in the fields

| Field | Value |
| ------ | ------ |
| Server | '' |
| Test Mode | Deactivate in `production` environment, keep this option active in every other environment |
| Viabill api key | Your api key from viabill |
| Viabill secret key | Your secret key from viabill |
| Viabill success url | full address + '/api/checkout_success' |
| Viabill cancel url | full address + '/checkout/payment' |
| Viabill checkout url | full address + '/api/checkout_callback' |
| Viabill test | `false` for production environment and `true` for the rest |

It is important to fill these fields as the value in these fields allow the extension to interface with Viabill. Click on the `Update` button once all the fields are filled.

### 2. Static Credentials Method

After the payment method is successfully created , you can select the `viabill_credentials` option from the `Preference Source` field in the form.

This will allow the extension to load static credentails from the ENV variables.

You can load static credentials by using the following environment variables when deploying your rails application.

| ENV Variable | Value |
| ------ | ------ |
| VIABILL_API_KEY | Your api key from viabill |
| VIABILL_SECRET_KEY | Your secret key from viabill |
| VIABILL_SUCCESS_URL | full address + '/api/checkout_success' |
| VIABILL_CANCEL_URL | full address + '/checkout/payment' |
| VIABILL_CALLBACK_URL | full address + '/api/checkout_callback' |
| VIABILL_TEST_ENV | `false` for production environment and `true` for the rest |

-

After everything is successfully completed you can see your new payment method in the payment options for an order.

## Development

### Testing the extension

First bundle your dependencies, then run `bin/rake`. `bin/rake` will default to building the dummy
app if it does not exist, then it will run specs. The dummy app can be regenerated by using
`bin/rake extension:test_app`.

```shell
bin/rake
```

To run [Rubocop](https://github.com/bbatsov/rubocop) static code analysis run

```shell
bundle exec rubocop
```

When testing your application's integration with this extension you may use its factories.
Simply add this require statement to your `spec/spec_helper.rb`:

```ruby
require 'solidus_viabill/testing_support/factories'
```

Or, if you are using `FactoryBot.definition_file_paths`, you can load Solidus core
factories along with this extension's factories using this statement:

```ruby
SolidusDevSupport::TestingSupport::Factories.load_for(SolidusViabill::Engine)
```

### Running the sandbox

To run this extension in a sandboxed Solidus application, you can run `bin/sandbox`. The path for
the sandbox app is `./sandbox` and `bin/rails` will forward any Rails commands to
`sandbox/bin/rails`.

Here's an example:

```
$ bin/rails server
=> Booting Puma
=> Rails 6.0.2.1 application starting in development
* Listening on tcp://127.0.0.1:3000
Use Ctrl-C to stop
```

### Updating the changelog

Before and after releases the changelog should be updated to reflect the up-to-date status of
the project:

```shell
bin/rake changelog
git add CHANGELOG.md
git commit -m "Update the changelog"
```

### Releasing new versions

Please refer to the dedicated [page](https://github.com/solidusio/solidus/wiki/How-to-release-extensions) on Solidus wiki.

## License

Copyright (c) 2022 [name of extension author], released under the New BSD License.
